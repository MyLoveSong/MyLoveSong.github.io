// Èü≥‰πêÁΩëÁ´ôÊ†∏ÂøÉÂäüËÉΩÁ±ª
class MusicWebsiteCore {
    constructor() {
        this.musicWorks = [];
        this.konamiCode = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'KeyB', 'KeyA'];
        this.konamiIndex = 0;
        this.eventListeners = new Set();
    }

    // Èü≥‰πê‰ΩúÂìÅÂ±ïÁ§∫
    setupMusicWorks() {
        // Ê®°ÊãüÈü≥‰πê‰ΩúÂìÅÊï∞ÊçÆ
        this.musicWorks = [
            {
                id: 1,
                title: "Â∑¥Ëµ´Âπ≥ÂùáÂæãÈí¢Áê¥Êõ≤ÈõÜ",
                composer: "Á∫¶Áø∞¬∑Â°ûÂ∑¥ÊñØËíÇÂÆâ¬∑Â∑¥Ëµ´",
                genre: "Âè§ÂÖ∏",
                year: "1722-1742",
                description: "Ë¢´Ë™â‰∏∫Èí¢Áê¥Èü≥‰πêÁöÑ„ÄäÊóßÁ∫¶Âú£Áªè„ÄãÔºåÂåÖÂê´48È¶ñÂâçÂ•èÊõ≤‰∏éËµãÊ†º„ÄÇ",
                image: "images/Âè§ÂÖ∏.jpg",
                audio: "audio/bach-prelude.mp3"
            },
            {
                id: 2,
                title: "ËìùËâ≤ÁãÇÊÉ≥Êõ≤",
                composer: "‰πîÊ≤ª¬∑Ê†º‰ªÄÊ∏©",
                genre: "ÁàµÂ£´",
                year: "1924",
                description: "ËûçÂêàÂè§ÂÖ∏Èü≥‰πê‰∏éÁàµÂ£´‰πêÂÖÉÁ¥†ÁöÑÁªèÂÖ∏‰ΩúÂìÅ„ÄÇ",
                image: "images/ÂÆûÈ™å.jpg",
                audio: "audio/blue-rhapsody.mp3"
            },
            {
                id: 3,
                title: "Always",
                composer: "Bon Jovi",
                genre: "ÊµÅË°å",
                year: "1994",
                description: "ÁªèÂÖ∏ÊëáÊªöÊÉÖÊ≠åÔºå‰º†Âî±Â∫¶ÊûÅÈ´òÁöÑÊµÅË°åÈáëÊõ≤„ÄÇ",
                image: "images/always.png",
                audio: "audio/always.mp3"
            },
            {
                id: 4,
                title: "Blond",
                composer: "Frank Ocean",
                genre: "ÂÆûÈ™å",
                year: "2016",
                description: "ÂâçÂç´ÁöÑÂÆûÈ™åÊÄßÈü≥‰πê‰ΩúÂìÅÔºåÁ™ÅÁ†¥‰º†ÁªüÈü≥‰πêÁïåÈôê„ÄÇ",
                image: "images/blond.jpg",
                audio: "audio/blond.mp3"
            }
        ];

        this.renderFilterButtons();
        this.renderMusicWorks();
    }

    renderFilterButtons() {
        const filterContainer = document.getElementById('filter-buttons');
        if (!filterContainer) return;

        filterContainer.innerHTML = ''; // Ê∏ÖÁ©∫ÊóßÊåâÈíÆ

        const genres = [...new Set(this.musicWorks.map(work => work.genre))];

        // Ê∑ªÂä†"ÂÖ®ÈÉ®"ÊåâÈíÆ
        const allButton = document.createElement('button');
        allButton.textContent = 'ÂÖ®ÈÉ®';
        allButton.className = 'filter-button active';
        allButton.type = 'button';
        allButton.dataset.genre = 'all';
        allButton.addEventListener('click', (e) => this.filterWorks('all', e));
        filterContainer.appendChild(allButton);

        // Ê∑ªÂä†ÂÖ∂‰ªñÁ≠õÈÄâÊåâÈíÆ
        genres.forEach(genre => {
            const button = document.createElement('button');
            button.textContent = genre;
            button.className = 'filter-button';
            button.type = 'button';
            button.dataset.genre = genre;
            button.addEventListener('click', (e) => this.filterWorks(genre, e));
            filterContainer.appendChild(button);
        });
    }

    renderMusicWorks(filteredWorks = null) {
        const worksContainer = document.getElementById('works-grid');
        if (!worksContainer) return;

        const worksToRender = filteredWorks || this.musicWorks;
        
        worksContainer.innerHTML = worksToRender.map(work => `
            <div class="work-card" data-genre="${work.genre}">
                <div class="work-image">
                    <img src="${work.image}" alt="${work.title}" loading="lazy">
                    <div class="work-overlay">
                        <button class="play-button" data-audio="${work.audio}">
                            <span class="play-icon">‚ñ∂</span>
                        </button>
                    </div>
                </div>
                <div class="work-info">
                    <h3 class="work-title">${work.title}</h3>
                    <p class="work-composer">${work.composer}</p>
                    <p class="work-year">${work.year}</p>
                    <p class="work-description">${work.description}</p>
                    <span class="work-genre">${work.genre}</span>
                </div>
            </div>
        `).join('');

        // Ê∑ªÂä†Êí≠ÊîæÊåâÈíÆ‰∫ã‰ª∂
        worksContainer.querySelectorAll('.play-button').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                const audioSrc = button.dataset.audio;
                this.playAudio(audioSrc);
            });
        });
    }

    filterWorks(genre, event) {
        // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
        document.querySelectorAll('.filter-button').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        // Á≠õÈÄâ‰ΩúÂìÅ
        let filteredWorks;
        if (genre === 'all') {
            filteredWorks = this.musicWorks;
        } else {
            filteredWorks = this.musicWorks.filter(work => work.genre === genre);
        }

        // Ê∑ªÂä†ËøáÊ∏°Âä®Áîª
        const worksContainer = document.getElementById('works-grid');
        worksContainer.style.opacity = '0';
        worksContainer.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            this.renderMusicWorks(filteredWorks);
            worksContainer.style.opacity = '1';
            worksContainer.style.transform = 'translateY(0)';
        }, 200);
    }

    // Êí≠ÊîæÈü≥È¢ë
    playAudio(audioSrc) {
        // ÂÅúÊ≠¢ÂΩìÂâçÊí≠ÊîæÁöÑÈü≥È¢ë
        const currentAudio = document.querySelector('audio');
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.remove();
        }

        // ÂàõÂª∫Êñ∞ÁöÑÈü≥È¢ëÂÖÉÁ¥†
        const audio = document.createElement('audio');
        audio.src = audioSrc;
        audio.controls = true;
        audio.style.cssText = `
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            border-radius: 8px;
            padding: 10px;
        `;
        
        document.body.appendChild(audio);
        audio.play().catch(e => console.log('Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:', e));
    }

    // Konami Code ÂΩ©Ëõã
    setupKonamiCode() {
        document.addEventListener('keydown', (e) => {
            if (e.code === this.konamiCode[this.konamiIndex]) {
                this.konamiIndex++;
                if (this.konamiIndex === this.konamiCode.length) {
                    this.triggerKonamiCode();
                    this.konamiIndex = 0;
                }
            } else {
                this.konamiIndex = 0;
            }
        });
    }

    triggerKonamiCode() {
        // ÂêØÂä®Èü≥‰πêËäÇÊãçÂ§ßÂ∏àÂ∞èÊ∏∏Êàè
        const game = new MusicBeatMasterGame();
        game.startMusicBeatMasterGame();
    }

    showVisualEasterEgg() {
        const body = document.body;
        body.style.animation = 'rainbow 2s infinite';
        
        // ÂàõÂª∫ÂΩ©ËôπÂä®Áîª
        const style = document.createElement('style');
        style.textContent = `
            @keyframes rainbow {
                0% { filter: hue-rotate(0deg); }
                100% { filter: hue-rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
        
        // ÂàõÂª∫Èü≥Á¨¶Èõ®
        this.createNoteRain();
        
        // ÂàõÂª∫‰∫îÁ∫øË∞±Ê≥¢Âä®
        this.createStaffWave();
        
        // 3ÁßíÂêéÊÅ¢Â§çÊ≠£Â∏∏
        setTimeout(() => {
            body.style.animation = '';
            style.remove();
        }, 3000);
    }

    // Èü≥Á¨¶Èõ®Âä®Áîª
    createNoteRain() {
        const notes = ['‚ô™', '‚ô©', '‚ô´', '‚ô¨', 'ùÑû', 'ùÑ¢'];
        const container = document.createElement('div');
        container.className = 'note-rain-container';
        container.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        `;
        
        document.body.appendChild(container);
        
        // ÂàõÂª∫Èü≥Á¨¶
        for (let i = 0; i < 50; i++) {
            setTimeout(() => {
                const note = document.createElement('div');
                note.textContent = notes[Math.floor(Math.random() * notes.length)];
                note.style.cssText = `
                    position: absolute;
                    left: ${Math.random() * 100}%;
                    top: -50px;
                    font-size: ${Math.random() * 20 + 16}px;
                    color: rgba(255, 255, 255, ${Math.random() * 0.5 + 0.3});
                    animation: noteFall ${Math.random() * 3 + 2}s linear forwards;
                `;
                
                container.appendChild(note);
                
                // Âä®ÁîªÁªìÊùüÂêéÁßªÈô§
                setTimeout(() => note.remove(), 5000);
            }, i * 100);
        }
        
        // Ê∑ªÂä†CSSÂä®Áîª
        if (!document.getElementById('note-rain-style')) {
            const style = document.createElement('style');
            style.id = 'note-rain-style';
            style.textContent = `
                @keyframes noteFall {
                    to {
                        transform: translateY(100vh) rotate(360deg);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        // 5ÁßíÂêéÁßªÈô§ÂÆπÂô®
        setTimeout(() => container.remove(), 5000);
    }

    // ‰∫îÁ∫øË∞±Ê≥¢Âä®Âä®Áîª
    createStaffWave() {
        const container = document.createElement('div');
        container.className = 'staff-wave-container';
        container.style.cssText = `
            position: fixed;
            bottom: 50px;
            left: 0;
            width: 100%;
            height: 100px;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        `;
        
        document.body.appendChild(container);
        
        // ÂàõÂª∫‰∫îÁ∫øË∞±
        const staff = document.createElement('div');
        staff.style.cssText = `
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: repeating-linear-gradient(
                to bottom,
                transparent 0,
                transparent 18px,
                #333 18px,
                #333 20px
            );
            animation: staffWave 2s ease-in-out infinite;
        `;
        
        container.appendChild(staff);
        
        // Ê∑ªÂä†CSSÂä®Áîª
        if (!document.getElementById('staff-wave-style')) {
            const style = document.createElement('style');
            style.id = 'staff-wave-style';
            style.textContent = `
                @keyframes staffWave {
                    0%, 100% { transform: translateX(0); }
                    50% { transform: translateX(20px); }
                }
            `;
            document.head.appendChild(style);
        }
        
        // 5ÁßíÂêéÁßªÈô§ÂÆπÂô®
        setTimeout(() => container.remove(), 5000);
    }

    // È°µÈù¢ÂèØËßÅÊÄßÂΩ©Ëõã
    setupPageVisibility() {
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                document.title = 'Âà´Ëµ∞ÂëÄÔºåÂø´ÂõûÊù•ÔºÅüéµ';
            } else {
                document.title = 'Èü≥‰πêÁõõÂÆ¥ - Èü≥‰πêÂÆ∂ÁöÑËâ∫ÊúØÂ§©Âú∞';
            }
        });
    }

    // ÊÄßËÉΩ‰ºòÂåñËÆæÁΩÆ
    setupPerformanceOptimizations() {
        // È¢ÑÂä†ËΩΩÂÖ≥ÈîÆËµÑÊ∫ê
        this.preloadCriticalResources();
        
        // ËÆæÁΩÆËµÑÊ∫êÊèêÁ§∫
        this.setupResourceHints();
        
        // ÂõæÁâáÊáíÂä†ËΩΩ
        this.setupLazyLoading();
        
        // ÊÄßËÉΩÁõëÊéß
        this.setupPerformanceMonitoring();
        
        // ÂÜÖÂ≠òÁÆ°ÁêÜ
        this.setupMemoryManagement();
    }

    // È¢ÑÂä†ËΩΩÂÖ≥ÈîÆËµÑÊ∫ê
    preloadCriticalResources() {
        const criticalResources = [
            'css/main.css',
            'images/È∏°Âì•ËÇñÂÉèÊùÉ.jpg',
            'images/always.png'
        ];
        
        criticalResources.forEach(resource => {
            const link = document.createElement('link');
            link.rel = 'preload';
            link.href = resource;
            link.as = resource.endsWith('.css') ? 'style' : 'image';
            document.head.appendChild(link);
        });
    }

    // ËÆæÁΩÆËµÑÊ∫êÊèêÁ§∫
    setupResourceHints() {
        // DNS È¢ÑËß£Êûê
        const dnsPrefetch = ['//fonts.googleapis.com', '//cdn.jsdelivr.net'];
        dnsPrefetch.forEach(domain => {
            const link = document.createElement('link');
            link.rel = 'dns-prefetch';
            link.href = domain;
            document.head.appendChild(link);
        });
        
        // È¢ÑËøûÊé•
        const preconnect = ['//fonts.gstatic.com'];
        preconnect.forEach(domain => {
            const link = document.createElement('link');
            link.rel = 'preconnect';
            link.href = domain;
            document.head.appendChild(link);
        });
    }

    // ÂõæÁâáÊáíÂä†ËΩΩ
    setupLazyLoading() {
        if ('IntersectionObserver' in window) {
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.classList.remove('lazy');
                        observer.unobserve(img);
                    }
                });
            });
            
            document.querySelectorAll('img[data-src]').forEach(img => {
                imageObserver.observe(img);
            });
        }
    }

    // ÊÄßËÉΩÁõëÊéß
    setupPerformanceMonitoring() {
        // ÁõëÊéßÈ°µÈù¢Âä†ËΩΩÊÄßËÉΩ
        window.addEventListener('load', () => {
            setTimeout(() => {
                const perfData = performance.getEntriesByType('navigation')[0];
                const loadTime = perfData.loadEventEnd - perfData.loadEventStart;
                
                console.log(`È°µÈù¢Âä†ËΩΩÊó∂Èó¥: ${loadTime}ms`);
                
                // Â¶ÇÊûúÂä†ËΩΩÊó∂Èó¥ËøáÈïøÔºåÂèØ‰ª•ÂèëÈÄÅÂà∞ÂàÜÊûêÊúçÂä°
                if (loadTime > 3000) {
                    this.reportPerformanceIssue('slow_load', loadTime);
                }
            }, 0);
        });

        // ÁõëÊéßÈïø‰ªªÂä°
        if ('PerformanceObserver' in window) {
            const observer = new PerformanceObserver((list) => {
                list.getEntries().forEach(entry => {
                    if (entry.duration > 50) {
                        this.reportPerformanceIssue('long_task', entry.duration);
                    }
                });
            });
            observer.observe({ entryTypes: ['longtask'] });
        }
    }

    // ÂÜÖÂ≠òÁÆ°ÁêÜ
    setupMemoryManagement() {
        // Ê∏ÖÁêÜ‰∫ã‰ª∂ÁõëÂê¨Âô®
        this.eventListeners = new Set();
        
        // È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜËµÑÊ∫ê
        window.addEventListener('beforeunload', () => {
            this.cleanup();
        });
    }

    // Ê∏ÖÁêÜËµÑÊ∫ê
    cleanup() {
        // Ê∏ÖÁêÜ‰∫ã‰ª∂ÁõëÂê¨Âô®
        if (this.eventListeners) {
            this.eventListeners.forEach(listener => {
                document.removeEventListener(listener.type, listener.handler);
            });
            this.eventListeners.clear();
        }
        
        // Ê∏ÖÁêÜÈü≥È¢ëÂÖÉÁ¥†
        const audios = document.querySelectorAll('audio');
        audios.forEach(audio => {
            audio.pause();
            audio.remove();
        });
        
        // Ê∏ÖÁêÜÂä®ÁîªÂÖÉÁ¥†
        const animatedElements = document.querySelectorAll('.note-rain-container, .staff-wave-container');
        animatedElements.forEach(el => el.remove());
        
        // Ê∏ÖÁêÜÊ†∑Âºè
        const dynamicStyles = document.querySelectorAll('#note-rain-style, #staff-wave-style');
        dynamicStyles.forEach(style => style.remove());
        
        // Ê∏ÖÁêÜÁ≤íÂ≠êÂä®Áîª
        if (window.uiEffectsManager) {
            window.uiEffectsManager.cleanup();
        }
        
        // Ê∏ÖÁêÜÂú∞Âõæ
        if (window.mapManager && window.mapManager.mapInstance) {
            window.mapManager.mapInstance.remove();
        }
        
        // Ê∏ÖÁêÜÁ™óÂè£‰∫ã‰ª∂ÁõëÂê¨Âô®
        if (this.debouncedResize) {
            window.removeEventListener('resize', this.debouncedResize);
        }
    }

    // Êä•ÂëäÊÄßËÉΩÈóÆÈ¢ò
    reportPerformanceIssue(type, value) {
        // ËøôÈáåÂèØ‰ª•ÂèëÈÄÅÂà∞ÊÄßËÉΩÁõëÊéßÊúçÂä°
        console.warn(`ÊÄßËÉΩÈóÆÈ¢ò: ${type} = ${value}`);
    }

    // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÁî®‰∫éÂÜÖÂ≠òÁÆ°ÁêÜÔºâ
    addEventListener(type, handler) {
        document.addEventListener(type, handler);
        this.eventListeners.add({ type, handler });
    }

    // ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨Âô®
    removeEventListener(type, handler) {
        document.removeEventListener(type, handler);
        this.eventListeners.delete({ type, handler });
    }
}
