# OpenAI API 集成使用说明

## 功能概述

你的地图系统现在已经集成了OpenAI的DALL-E 3图片生成API，可以为每个城市自动生成特色图片，大大提升地图的视觉效果和用户体验。

## 主要特性

### 🎨 AI图片生成
- **智能提示词**：根据城市类型（音乐、文化、自然、美食、冒险）自动生成相应的图片风格
- **高质量输出**：使用DALL-E 3模型，生成1024x1024分辨率的自然风格图片
- **批量处理**：支持一键为所有城市生成图片

### 💾 智能缓存系统
- **避免重复调用**：已生成的图片会被缓存，不会重复调用API
- **本地存储**：API密钥安全存储在本地，无需重复输入
- **成本控制**：智能的批次处理和延迟机制，避免API限制

### 🔧 用户友好界面
- **一键设置**：在地图控制面板中直接输入和设置API密钥
- **实时状态**：显示图片生成进度和缓存状态
- **错误处理**：优雅处理API调用失败的情况

## 使用方法

### 1. 设置API密钥
1. 在地图左侧控制面板中找到"🤖 AI图片生成"区域
2. 在输入框中输入你的OpenAI API密钥
3. 点击"🔑 设置API密钥"按钮
4. 密钥会自动保存到本地存储

### 2. 生成单个城市图片
1. 点击地图上的城市标记
2. 在弹窗中如果没有图片，会显示"🎨 生成AI图片"按钮
3. 点击按钮即可为该城市生成AI图片

### 3. 批量生成所有城市图片
1. 设置好API密钥后，控制面板会显示"🎨 生成所有城市图片"按钮
2. 点击按钮开始批量生成
3. 系统会自动分批处理，避免API限制

## 技术细节

### API配置
```javascript
this.openAIConfig = {
    apiKey: '', // 用户设置的API密钥
    baseURL: 'https://api.openai.com/v1',
    imageModel: 'dall-e-3', // 使用最新的DALL-E 3模型
    maxRetries: 3, // 最大重试次数
    retryDelay: 1000 // 重试延迟（毫秒）
};
```

### 图片生成提示词示例
- **北京（文化）**：中国城市 北京，中国的首都，拥有悠久的历史文化和现代都市魅力。历史文化氛围浓厚，古建筑与现代建筑融合，传统与现代并存。高质量摄影风格，4K分辨率，真实感强，适合作为旅游宣传图片。

- **成都（美食）**：中国城市 成都，天府之国，慢生活与麻辣美食的完美结合。美食文化丰富，热闹的街市，各种美食摊位，烟火气息浓厚。高质量摄影风格，4K分辨率，真实感强，适合作为旅游宣传图片。

### 缓存机制
- 使用`Map`数据结构存储图片URL
- 防止重复生成同一城市的图片
- 支持本地存储API密钥

## 注意事项

### API限制
- OpenAI API有调用频率限制，建议不要过于频繁地生成图片
- 系统已实现智能批次处理和延迟机制
- 建议在非高峰期使用批量生成功能

### 成本控制
- 每张图片生成都会消耗API配额
- 建议先为重要城市生成图片
- 已生成的图片会被缓存，不会重复收费

### 图片质量
- 生成的图片质量取决于提示词的质量
- 系统已优化提示词模板，确保生成高质量的旅游宣传图片
- 支持根据城市类型调整图片风格

## 故障排除

### 常见问题
1. **API密钥无效**：检查密钥是否正确，是否有足够的配额
2. **图片生成失败**：检查网络连接，API服务是否正常
3. **缓存问题**：清除浏览器缓存或重新设置API密钥

### 调试信息
- 打开浏览器控制台查看详细的日志信息
- 系统会记录每个步骤的执行状态
- 错误信息会显示具体的失败原因

## 未来扩展

### 计划功能
- **图片风格选择**：允许用户选择不同的图片风格
- **批量下载**：支持批量下载生成的图片
- **图片编辑**：集成图片编辑功能
- **多语言支持**：支持英文等其他语言的提示词

### 技术优化
- **图片压缩**：优化图片大小，提升加载速度
- **CDN集成**：使用CDN加速图片加载
- **智能缓存**：更智能的缓存策略

---

**注意**：使用OpenAI API需要有效的API密钥和足够的配额。请确保遵守OpenAI的使用条款和限制。
